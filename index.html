<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ช่วยคำนวนต้นทุนในการปลูก</title>
  <!--<link rel="stylesheet" href="css/style.css" media="all"> -->
  <script>
    document.write('<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons' + new Date().getTime + '">')
  </script>
  <link rel="shortcut icon" href="icon/icon.ico" type="image/x-icon" />
  <link rel="icon" href="icon/icon.ico" type="image/x-icon" />
  <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;700&display=swap" />
  <style media="screen">
  </style>
</head>
<body>
  <div class="container">
    <div class="row">
      <div class="center-align">
        <h5>สวัสดีคับ</h5>
      </div>
    </div>
  <div class="row">
    <form id="fruitForm" class="col s12" autocomplete="off">
      <!-- Start fruit-->
      <label><h6>เลือกพืชที่คุณต้องการปลูกได้เลย</h6></label>
      <select
        id="fruit"
        class="browser-default"
        required
        class="validate"
      >
        <option value="" disabled selected>ชนิดพืชผักผลไม้</option>
        <option value="1">ข้าวนาปรัง</option>
        <option value="2">ข้าวนาปี</option>
        <option value="3">ถั่วเขียว</option>
        <option value="4">มันสำปะหลัง</option>
        <option value="5">ข้าวโพดเลี้ยงสัตว์</option>
        <option value="6">อ้อยโรงงาน</option>
        <option value="7">ข้าวโพดเลี้ยงสัตว์</option>
        <option value="8">ถั่วลิสง</option>
        <option value="9">มะพร้าว</option>
        <option value="10">ทุเรียนหมอนทอง</option>
        <option value="11">ทุเรียนหลงรับแล</option>
        <option value="12">ทุเรียนหลินรับแล</option>
        <option value="13">มะม่วงหิมพานต์</option>
        <option value="14">ลำไย</option>
        <option value="15">เงาะโรงเรียน</option>
      </select>
      <!-- End fruit -->

      <!-- start square -->
      <div class="input-field">
        <label for="square"><h6>จำนวนไรที่ท่านต้องการปลูก</h6></label>
        <input id="square" type="text" required class="validate" />
      </div>
      <!-- End suware -->

      <!-- start soil -->
      <div class="input-field">
        <label for="soil"><h6>ค่าเตรียมดิน </h6></label>
        <input id="soil" type="text" required class="validate" />
      </div>
      <!-- End soil -->

      <!-- start plant -->
      <div class="input-field">
        <label for="plant"><h6>ค่าปลูก และค่าเตรียมพันธุ์ </h6></label>
        <input id="plant" type="text" required class="validate" />
      </div>
      <!-- End plant -->

      <!-- start prepare -->
      <div class="input-field">
        <label for="prepare"><h6>ค่าดูแลพืช</h6></label>
        <input id="prepare" type="text" required class="validate" />
      </div>
      <!-- End prepare -->

      <!-- start harvest -->
      <div class="input-field">
        <label for="harvest"><h6>ค่าเก็บเกี่ยว รวบรวม</h6></label>
        <input id="harvest" type="text" required class="validate" />
      </div>
      <!-- End harvest -->
      
      <!-- start varieties -->
      <div class="input-field">
        <label for="varient"><h6>ค่าปลูก และค่าเตรียมพันธุ์ </h6></label>
        <input id="varient" type="text" required class="validate" />
      </div>
      <!-- End varieties -->

      <!-- start fertilizer -->
      <div class="input-field">
        <label for="fertilizer"><h6>ค่าปุ๋ย</h6></label>
        <input id="fertilizer" type="text" required class="validate" />
      </div>
      <!-- End fertilizer -->

      <!-- start insect -->
      <div class="input-field">
        <label for="insect"><h6>ค่ายาฆ่าแมลงและกำจัดศัตรูพืช</h6></label>
        <input id="insect" type="text" required class="validate" />
      </div>
      <!-- End insect -->

      <!-- start etc -->
      <div class="input-field">
        <label for="etc"><h6>ค่าอื่นๆ เช่นนำมันเชื่อเพลิงค่าซ่อมอุปกรณ์</h6></label>
        <input id="etc" type="text" required class="validate" />
      </div>
      <!-- End etc -->

      <!-- start land -->
      <div class="input-field">
        <label for="land"><h6>ค่าเช่าที่ดิน</h6></label>
        <input id="land" type="text" required class="validate" />
      </div>
      <!-- End land -->

      <!-- Start submit Button -->
      <button id="btn" class="btn waves-effect waves-light" type="submit">
        คำนวณ
      </button>
      <!-- End submit Button -->
      </select>
    </form>
  </div>
  <!-- End Form Content -->
  <button id="btnLogOut" onclick="logOut()">Log Out</button>
  <button id="btnClose" onclick="closed()">Close</button>

  <script src="js/vconsole.min.js"></script> 
  <script>
    var vConsole = new VConsole()
    console.log("Hello World!")
    errorPlease()
  </script> 

  <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/autonumeric@4.5.4"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>

    function runApp() {
      let square = new AutoNumeric("#square","integerPos");
      let soil = new AutoNumeric("#soil","integerPos");
      let plant = new AutoNumeric("#plant","integerPos");
      let prepare = new AutoNumeric("#prepare","integerPos");
      let harvest = new AutoNumeric("#harvest","integerPos");
      let varieties = new AutoNumeric("#varieties","integerPos");
      let fertilizer = new AutoNumeric("#fertilizer","integerPos");
      let insect = new AutoNumeric("#insect","integerPos");
      let etc = new AutoNumeric("#etc","integerPos");
      let land = new AutoNumeric("#land","integerPos");

      let fruit = document.getElementById("fruitForm");
      form.addEventListener("submit",submitForm);

      function submitForm(e) {
        e.preventDefault();

        let fruit = Number(getInputValue("fruit"))
        let square = Number(getInputValue("square").replace(/,/g, ""));
        let soil = Number(getInputValue("soil").replace(/,/g, ""));
        let plant = Number(getInputValue("plant").replace(/,/g, ""));
        let prepare = Number(getInputValue("prepare").replace(/,/g, ""));
        let harvest = Number(getInputValue("harvest").replace(/,/g, ""));
        let varieties = Number(getInputValue("varieties").replace(/,/g, ""));
        let fertilizer = Number(getInputValue("fertilizer").replace(/,/g, ""));
        let insect = Number(getInputValue("insect").replace(/,/g, ""));
        let etc = Number(getInputValue("etc").replace(/,/g, ""));
        let land = Number(getInputValue("land").replace(/,/g, ""));

        //reset form
        form.reset();
        square.clear(true);
        soil.clear(true);
        plant.clear(true);
        prepare.clear(true);
        harvest.clear(true);
        varieties.clear(true);
        fertilizer.clear(true);
        insect.clear(true);
        etc.clear(true);
        land.clear(true);

        //ค่าวัสดุ + ค่าแรงงาน
        let expenses = soil + plant + prepare + harvest + varieties + fertilizer + insect + etc;
       
        //ต้นทุนรวมของเกษตรกร
        let resultCalculate = paymentCalculate(fruit,expenses);

         createResultTable(
           fruit,
           square,
           expenses,
           resultCalculate
         );  
         if (
          liff.getContext().type !== "none" &&
          liff.getContext().type !== "external"
        ) {
            // Create flex message
          let message = createFlexMessage(
            fruit,
              expenses,
              resultCalculate
            );
            // Send messages
            liff
              .sendMessages(message)
              .then(() => {
                liff.closeWindow();
              })
              .catch((err) => {
                console.error(err.code, error.message);
              });
          } else {
            // Result table
            createResultTable(
              expenses,
              resultCalculate
            );
          }  
      }
      // function to get form values
      function getInputValue(id){
        return document.getElementById(id).value;
      }
      var expensesIncludeVat =0;
      function vatRateCalculation(expenses, vatRate){
        let result = {};
        Object.keys(vatRate).forEach((term) => {
          let vat = expenses * ( 6.5 / 100) ;
          expensesIncludeVat = expenses + vat; 

        })
      }

      // เดี๋ยวมาทำ
      function paymentCalculate(fruit,expensesIncludeVat) {
        switch (fruit) {
          case 1:
            let resultCalculate = {};
            Object.keys(brokenRate).forEach((term) =>{
              let broken = 25.05 * square;
              let resultCalculate = expensesIncludeVat + broken;

              result[term] = {
                resultCalculate: numberToString(resultCalculate),
                broken: numberToString(broken),
              };
            })
        }
      }

      return result;

    }

    function numberToString(number){
      return number.toLocaleString("en-Us",{
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      });
    }

    function createResultTable(
      fruit,
      square,
      expenses,
      resultCalculate
    ) {
      let frutiTxt = numberToString(fruit);
      let expensesTxt = numberToString(expenses);
      let resultCalculateTxt = numberToString(resultCalculate)

      document.getElementById(
        "result"
      ).innerHTML = `<!-- Add Table Data wiht Script -->
        <table class="responsive-table">
          <thead>
            <tr>
              <th>พืชที่คุณเลือกจะปลูก</th>
              <th>ค่าวัสดุและข้าแรงงาน</th>
              <th>ต้นทุนทั้งหมด</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td>${fruitTxt}</td>
              <td>${expensesTxt}</td>
              <td>${resultCalculateTxt}</td>
              <td>${installment36}</td>
              <td>${installment48}</td>
              <td>${installment60}</td>
              <td>${installment72}</td>
            </tr>
          </tbody>
        </table>
        <div class="red-text">
          <p> ต้นทุนทั้งหมดนี้รวมถึง </p>
          <p>
            ภาษี ค่าเสื่อมอุปกรณ์ และค่าเสียโอกาศอุปกรณ์
          </p>
        </div>`;   
    function createFlexMessage(carYear, carPrice, downPayment, loan, resultCalculate) {
      let fruit = numberToString(fruit);
      let square = numberToString(square);
      let expenses = numberToString(expenses);
      let resultCalculate = numberToString(resultCalculate)
    }

    let flexJson = {};

    return [{ type: "flex", altText: "สู้ๆครับ", contents: flexJson }];
  
    }
    function logOut() {
      liff.logout()
      window.location.reload()
    }

    async function getFriendship() {
      const friend = await liff.getFriendship()
      document.getElementById("friendship").append(friend.friendFlag)
      if  (!friend.friendFlag) {
        if (confirm("ยังไม่ได้เป็นเพื่อนกับบอทจะเพิ่มเลยไหมงับ")){
          window.location = "https://line.me/R/ti/p/@800bzapf"
        }
      }
    }

    async function main() {
      liff.ready.then(() => {
        document.getElementById("isLoggedIn").append(liff.isLoggedIn())
        if (liff.isLoggedIn()) {
          getFriendship()
        } else {
          liff.login()
        }
      })
      await liff.init({ liffId: "1656679781-Y22GvjlN" }) 
    }
    main()
  </script>
</body>
</html>